<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#6366f1">
<link rel="manifest" href="manifest.json">
<title>×¢×•×–×¨ ××™×©×™ ×—×›×</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Frank+Ruhl+Libre:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a; --surface: #111827; --surface2: #1a2235;
    --border: #1e293b; --accent: #6366f1; --accent2: #a78bfa;
    --gold: #f59e0b; --green: #10b981; --red: #ef4444;
    --text: #e2e8f0; --muted: #64748b; --glow: rgba(99,102,241,0.3);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
  }
  body::before {
    content: ''; position: fixed; inset: 0;
    background: radial-gradient(ellipse 80% 50% at 20% 20%, rgba(99,102,241,0.08) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 80% 80%, rgba(167,139,250,0.06) 0%, transparent 60%);
    pointer-events: none; z-index: 0;
  }

  /* â”€â”€ INSTALL BANNER â”€â”€ */
  .install-banner {
    position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 14px; padding: 12px 18px;
    z-index: 500; display: none; align-items: center; gap: 10px;
    max-width: 340px; width: 92%; box-shadow: 0 8px 30px rgba(99,102,241,0.4);
    animation: slideDown 0.4s cubic-bezier(0.34,1.56,0.64,1);
  }
  .install-banner.show { display: flex; }
  @keyframes slideDown { from { transform: translateX(-50%) translateY(-60px); opacity:0; } to { transform: translateX(-50%) translateY(0); opacity:1; } }
  .install-banner span { flex:1; font-size:13px; font-weight:600; color:#fff; }
  .install-banner button { border:none; border-radius:8px; padding:6px 14px; font-family:'Heebo',sans-serif; font-size:13px; font-weight:700; cursor:pointer; }
  .install-btn-yes { background:#fff; color: var(--accent); }
  .install-btn-no { background: rgba(255,255,255,0.2); color:#fff; }

  .app { position:relative; z-index:1; max-width:1200px; margin:0 auto; padding:0 16px 110px; }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    padding: 20px 0 14px; display:flex; align-items:center;
    justify-content:space-between; border-bottom:1px solid var(--border); margin-bottom:20px;
  }
  .header-title {
    font-family:'Frank Ruhl Libre',serif; font-size:26px; font-weight:700;
    background: linear-gradient(135deg,#e2e8f0,#a78bfa);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .header-right { display:flex; flex-direction:column; align-items:flex-end; gap:4px; }
  .date-display { font-size:13px; color:var(--muted); text-align:left; }
  .date-display strong { color:var(--accent2); display:block; font-size:15px; }

  /* â”€â”€ BACKUP BUTTONS â”€â”€ */
  .backup-bar {
    display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;
  }
  .backup-bar button {
    flex:1; min-width:120px; padding:9px 12px; border:1px solid var(--border);
    background:var(--surface); color:var(--text); border-radius:10px;
    font-family:'Heebo',sans-serif; font-size:13px; font-weight:600;
    cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;
    transition: all 0.2s;
  }
  .backup-bar button:hover { border-color:var(--accent); background:var(--surface2); }

  /* â”€â”€ TABS â”€â”€ */
  .tabs {
    display:flex; gap:4px; background:var(--surface); border-radius:12px;
    padding:4px; margin-bottom:20px; overflow-x:auto; -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  .tabs::-webkit-scrollbar { display:none; }
  .tab {
    flex:1; min-width:70px; padding:9px 6px; border:none; background:transparent;
    color:var(--muted); cursor:pointer; border-radius:8px;
    font-family:'Heebo',sans-serif; font-size:12px; font-weight:500;
    transition:all 0.2s; display:flex; flex-direction:column; align-items:center; gap:3px;
  }
  .tab .tab-icon { font-size:17px; }
  .tab.active { background:var(--surface2); color:var(--text); box-shadow:0 2px 8px rgba(0,0,0,0.3); }

  .panel { display:none; }
  .panel.active { display:block; animation:fadeIn 0.3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px);} to{opacity:1;transform:translateY(0);} }

  /* â”€â”€ CARDS â”€â”€ */
  .card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:18px; margin-bottom:14px; }
  .card-title { font-size:15px; font-weight:700; margin-bottom:14px; display:flex; align-items:center; gap:8px; }

  /* â”€â”€ INPUTS â”€â”€ */
  input[type="text"],input[type="time"],input[type="date"],select,textarea {
    background:var(--surface2); border:1px solid var(--border); border-radius:10px;
    padding:10px 13px; color:var(--text); font-family:'Heebo',sans-serif;
    font-size:14px; outline:none; transition:border-color 0.2s; width:100%;
  }
  input:focus,select:focus,textarea:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(99,102,241,0.15); }
  textarea { resize:vertical; min-height:80px; }
  .form-row { margin-bottom:12px; }
  .form-label { font-size:12px; color:var(--muted); margin-bottom:5px; display:block; }
  .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn { padding:10px 16px; border:none; border-radius:10px; cursor:pointer; font-family:'Heebo',sans-serif; font-size:14px; font-weight:600; transition:all 0.2s; white-space:nowrap; }
  .btn-primary { background:var(--accent); color:#fff; }
  .btn-success { background:var(--green); color:#fff; }
  .btn-danger { background:var(--red); color:#fff; font-size:12px; padding:6px 11px; }
  .btn-gold { background:var(--gold); color:#1a1a1a; }
  .btn-sm { padding:6px 12px; font-size:12px; }

  /* â”€â”€ TASKS â”€â”€ */
  .task-item { display:flex; align-items:flex-start; gap:10px; padding:13px; background:var(--surface2); border-radius:12px; margin-bottom:8px; border:1px solid var(--border); transition:all 0.2s; }
  .task-item.done { opacity:0.5; }
  .task-item.done .task-name { text-decoration:line-through; }
  .task-check { width:22px; height:22px; min-width:22px; border-radius:6px; border:2px solid var(--border); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; font-size:13px; margin-top:2px; }
  .task-check.checked { background:var(--green); border-color:var(--green); }
  .task-info { flex:1; min-width:0; }
  .task-name { font-size:14px; font-weight:500; margin-bottom:4px; }
  .task-meta { display:flex; flex-wrap:wrap; gap:6px; }
  .badge { padding:2px 7px; border-radius:6px; font-size:11px; font-weight:600; }
  .badge-purple { background:rgba(99,102,241,0.2); color:var(--accent2); }
  .badge-gold { background:rgba(245,158,11,0.2); color:var(--gold); }
  .badge-green { background:rgba(16,185,129,0.2); color:var(--green); }
  .priority-high { border-right:3px solid var(--red); }
  .priority-medium { border-right:3px solid var(--gold); }
  .priority-low { border-right:3px solid var(--green); }

  /* â”€â”€ SCHEDULE â”€â”€ */
  .schedule-slot { display:flex; gap:10px; padding:12px; background:var(--surface2); border-radius:10px; margin-bottom:8px; border:1px solid var(--border); align-items:center; }
  .slot-time { font-size:12px; color:var(--accent2); font-weight:700; min-width:72px; text-align:center; }
  .slot-bar { width:3px; height:36px; background:linear-gradient(to bottom,var(--accent),var(--accent2)); border-radius:4px; }

  /* â”€â”€ REMINDERS â”€â”€ */
  .reminder-item { display:flex; align-items:center; gap:10px; padding:12px 13px; background:var(--surface2); border-radius:12px; margin-bottom:8px; border:1px solid var(--border); }
  .reminder-icon { font-size:20px; }
  .reminder-info { flex:1; min-width:0; }
  .reminder-title { font-size:14px; font-weight:600; }
  .tag-couple { background:rgba(244,63,94,0.2); color:#fb7185; }
  .tag-family { background:rgba(16,185,129,0.2); color:#6ee7b7; }
  .tag-work { background:rgba(99,102,241,0.2); color:var(--accent2); }
  .tag-friends { background:rgba(139,92,246,0.2); color:#c4b5fd; }
  .tag-personal { background:rgba(245,158,11,0.2); color:var(--gold); }

  /* â”€â”€ STATS â”€â”€ */
  .stats-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:14px; }
  .stat-card { background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px; text-align:center; }
  .stat-number { font-size:30px; font-weight:900; background:linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .stat-label { font-size:11px; color:var(--muted); margin-top:3px; }
  .progress-bar { height:7px; background:var(--border); border-radius:4px; overflow:hidden; margin-top:8px; }
  .progress-fill { height:100%; background:linear-gradient(to right,var(--accent),var(--accent2)); border-radius:4px; transition:width 0.5s ease; }

  /* â”€â”€ GROWTH â”€â”€ */
  .growth-item { display:flex; align-items:center; gap:10px; padding:13px; background:var(--surface2); border-radius:12px; margin-bottom:8px; cursor:pointer; border:1px solid var(--border); transition:border-color 0.2s; }
  .growth-item:active { border-color:var(--accent); }
  .growth-icon { font-size:22px; }
  .growth-text { flex:1; }
  .growth-title { font-size:14px; font-weight:600; }
  .growth-desc { font-size:12px; color:var(--muted); margin-top:2px; }

  /* â”€â”€ MEDITATION â”€â”€ */
  .meditation-ring { width:110px; height:110px; border-radius:50%; border:3px solid var(--border); margin:0 auto 14px; display:flex; align-items:center; justify-content:center; position:relative; font-size:26px; font-weight:700; color:var(--accent2); }
  .meditation-ring svg { position:absolute; inset:-3px; width:calc(100% + 6px); height:calc(100% + 6px); }
  .meditation-ring svg circle { fill:none; stroke:var(--accent); stroke-width:3; stroke-linecap:round; transform:rotate(-90deg); transform-origin:center; transition:stroke-dashoffset 1s linear; }

  /* â”€â”€ REVIEW â”€â”€ */
  .review-section { background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(167,139,250,0.05)); border:1px solid rgba(99,102,241,0.3); border-radius:16px; padding:20px; margin-bottom:14px; }
  .review-title { font-family:'Frank Ruhl Libre',serif; font-size:19px; margin-bottom:10px; color:var(--accent2); }

  /* â”€â”€ GRATITUDE BOX â”€â”€ */
  .gratitude-box { background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(251,191,36,0.05)); border:1px solid rgba(245,158,11,0.3); border-radius:16px; padding:18px; margin-bottom:14px; text-align:center; }
  .gratitude-quote { font-family:'Frank Ruhl Libre',serif; font-size:17px; color:var(--gold); margin-bottom:12px; line-height:1.5; }

  /* â”€â”€ SECTION DIVIDER â”€â”€ */
  .section-divider { display:flex; align-items:center; gap:10px; margin:18px 0 10px; color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:1px; }
  .section-divider::before,.section-divider::after { content:''; flex:1; height:1px; background:var(--border); }

  /* â”€â”€ STREAK â”€â”€ */
  .streak-display { display:flex; align-items:center; gap:12px; padding:14px; background:var(--surface2); border-radius:12px; margin-bottom:10px; }
  .streak-count { font-size:30px; font-weight:900; color:var(--gold); }
  .streak-text { font-size:12px; color:var(--muted); }

  /* â”€â”€ REPORT â”€â”€ */
  .report-section { border-radius:12px; padding:14px; margin-bottom:10px; }
  .report-good { background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); }
  .report-improve { background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); }
  .report-section h4 { font-size:14px; font-weight:700; margin-bottom:8px; }
  .report-section li { font-size:13px; padding:3px 0; list-style:none; }

  /* â”€â”€ VOICE FAB â”€â”€ */
  .voice-fab { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); z-index:100; display:flex; flex-direction:column; align-items:center; gap:6px; }
  .voice-btn { width:68px; height:68px; border-radius:50%; border:none; background:linear-gradient(135deg,var(--accent),var(--accent2)); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:26px; box-shadow:0 0 28px var(--glow),0 8px 28px rgba(0,0,0,0.5); transition:all 0.3s; }
  .voice-btn.listening { animation:pulse-ring 1.5s infinite; background:linear-gradient(135deg,#ef4444,#f59e0b); }
  @keyframes pulse-ring { 0%{box-shadow:0 0 0 0 rgba(239,68,68,0.6),0 8px 28px rgba(0,0,0,0.5);} 70%{box-shadow:0 0 0 18px rgba(239,68,68,0),0 8px 28px rgba(0,0,0,0.5);} 100%{box-shadow:0 0 0 0 rgba(239,68,68,0),0 8px 28px rgba(0,0,0,0.5);} }
  .voice-label { font-size:11px; color:var(--muted); }

  /* â”€â”€ TRANSCRIPT â”€â”€ */
  .transcript-bar { position:fixed; bottom:108px; left:50%; transform:translateX(-50%); background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:9px 18px; max-width:480px; width:88%; font-size:13px; color:var(--accent2); text-align:center; z-index:99; display:none; }
  .transcript-bar.active { display:block; }

  /* â”€â”€ MODALS â”€â”€ */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:200; display:none; align-items:center; justify-content:center; padding:16px; backdrop-filter:blur(4px); }
  .modal-overlay.active { display:flex; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:22px; width:100%; max-width:460px; max-height:88vh; overflow-y:auto; }
  .modal-title { font-size:17px; font-weight:700; margin-bottom:18px; }
  .modal-actions { display:flex; gap:8px; margin-top:18px; }
  .modal-actions .btn { flex:1; }

  /* â”€â”€ NOTIFICATION â”€â”€ */
  .notification { position:fixed; top:16px; left:50%; transform:translateX(-50%) translateY(-100px); background:var(--surface2); border:1px solid var(--accent); border-radius:12px; padding:11px 18px; font-size:14px; color:var(--accent2); z-index:300; transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); white-space:nowrap; max-width:88vw; text-align:center; }
  .notification.show { transform:translateX(-50%) translateY(0); }

  /* â”€â”€ EMPTY STATE â”€â”€ */
  .empty-state { text-align:center; padding:36px 20px; color:var(--muted); }
  .empty-state .empty-icon { font-size:44px; margin-bottom:10px; }
  .empty-state p { font-size:14px; }

  ::-webkit-scrollbar { width:5px; }
  ::-webkit-scrollbar-track { background:var(--bg); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  /* â”€â”€ ×›×¨×˜×™×¡ ×©×™×—×” ×§×•×œ×™×ª â”€â”€ */
  .voice-conv-card {
    position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%);
    background: linear-gradient(135deg, var(--surface2), #1e1b4b);
    border: 1px solid var(--accent); border-radius: 20px;
    padding: 18px 24px; max-width: 340px; width: 88%;
    z-index: 150; display: none; flex-direction: column;
    align-items: center; gap: 10px;
    box-shadow: 0 0 40px rgba(99,102,241,0.3); text-align: center;
  }
  .voice-conv-card.active { display: flex; animation: fadeIn 0.3s ease; }
  .voice-conv-waves { display:flex; gap:4px; align-items:center; height:24px; }
  .voice-conv-waves span { width:4px; background:var(--accent2); border-radius:4px; animation:wave 1s infinite ease-in-out; }
  .voice-conv-waves span:nth-child(1){height:8px;animation-delay:0s}
  .voice-conv-waves span:nth-child(2){height:16px;animation-delay:0.15s}
  .voice-conv-waves span:nth-child(3){height:24px;animation-delay:0.3s}
  .voice-conv-waves span:nth-child(4){height:16px;animation-delay:0.45s}
  .voice-conv-waves span:nth-child(5){height:8px;animation-delay:0.6s}
  @keyframes wave { 0%,100%{transform:scaleY(0.5);opacity:0.5} 50%{transform:scaleY(1);opacity:1} }
  .voice-conv-text { font-size:16px; font-weight:600; color:var(--text); line-height:1.5; }
  .voice-conv-hint { font-size:12px; color:var(--muted); }
  .voice-conv-card {
    position: fixed;
    bottom: 110px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--surface2), #1e1b4b);
    border: 1px solid var(--accent);
    border-radius: 20px;
    padding: 18px 24px;
    max-width: 340px;
    width: 88%;
    z-index: 150;
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    box-shadow: 0 0 40px rgba(99,102,241,0.3);
    text-align: center;
  }
  .voice-conv-card.active { display: flex; animation: fadeIn 0.3s ease; }
  .voice-conv-waves {
    display: flex;
    gap: 4px;
    align-items: center;
    height: 24px;
  }
  .voice-conv-waves span {
    width: 4px;
    background: var(--accent2);
    border-radius: 4px;
    animation: wave 1s infinite ease-in-out;
  }
  .voice-conv-waves span:nth-child(1) { height: 8px;  animation-delay: 0s; }
  .voice-conv-waves span:nth-child(2) { height: 16px; animation-delay: 0.15s; }
  .voice-conv-waves span:nth-child(3) { height: 24px; animation-delay: 0.3s; }
  .voice-conv-waves span:nth-child(4) { height: 16px; animation-delay: 0.45s; }
  .voice-conv-waves span:nth-child(5) { height: 8px;  animation-delay: 0.6s; }
  @keyframes wave {
    0%, 100% { transform: scaleY(0.5); opacity: 0.5; }
    50% { transform: scaleY(1); opacity: 1; }
  }
  .voice-conv-text {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.5;
  }
  .voice-conv-hint {
    font-size: 12px;
    color: var(--muted);
  }
</style>
</head>
<body>

<!-- PWA Install Banner -->
<div class="install-banner" id="installBanner">
  <span>ğŸ“² ×”×ª×§×Ÿ ×›××¤×œ×™×§×¦×™×” ×¢×œ ×”×¤×œ××¤×•×Ÿ!</span>
  <button class="install-btn-yes" onclick="installPWA()">×”×ª×§×Ÿ</button>
  <button class="install-btn-no" onclick="dismissInstall()">âœ•</button>
</div>

<div class="app">
  <!-- Header -->
  <div class="header">
    <div>
      <div class="header-title">âœ¦ ×¢×•×–×¨ ××™×©×™</div>
      <div style="font-size:12px;color:var(--muted);margin-top:2px;" id="headerGreeting">×©×œ×•×!</div>
    </div>
    <div class="header-right">
      <div class="date-display">
        <strong id="currentTime">00:00</strong>
        <span id="currentDate"></span>
      </div>
    </div>
  </div>

  <!-- Backup/Restore Bar -->
  <div class="backup-bar">
    <button onclick="exportData()">ğŸ“¤ ×’×‘×” × ×ª×•× ×™×</button>
    <button onclick="document.getElementById('importFile').click()">ğŸ“¥ ×©×—×–×¨ × ×ª×•× ×™×</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('today',this)"><span class="tab-icon">ğŸ“…</span>×”×™×•×</button>
    <button class="tab" onclick="switchTab('tasks',this)"><span class="tab-icon">âœ…</span>××©×™××•×ª</button>
    <button class="tab" onclick="switchTab('schedule',this)"><span class="tab-icon">ğŸ—“ï¸</span>×œ×•×–</button>
    <button class="tab" onclick="switchTab('reminders',this)"><span class="tab-icon">ğŸ””</span>×ª×–×›×•×¨×•×ª</button>
    <button class="tab" onclick="switchTab('growth',this)"><span class="tab-icon">ğŸŒ±</span>×¦××™×—×”</button>
    <button class="tab" onclick="switchTab('report',this)"><span class="tab-icon">ğŸ“Š</span>×“×•×—</button>
  </div>

  <!-- TODAY PANEL -->
  <div id="panel-today" class="panel active">
    <div class="gratitude-box">
      <div class="gratitude-quote" id="dailyQuote">×˜×•×¢×Ÿ...</div>
      <button class="btn btn-gold btn-sm" onclick="openModal('gratitudeModal')">ğŸ™ ×”×›×¨×ª ×ª×•×“×” ×‘×•×§×¨</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="statDone">0</div>
        <div class="stat-label">×”×•×©×œ××•</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      </div>
      <div class="stat-card"><div class="stat-number" id="statTotal">0</div><div class="stat-label">×¡×”"×› ××©×™××•×ª</div></div>
      <div class="stat-card"><div class="stat-number" id="statGrowth">0</div><div class="stat-label">××¢×©×™× ×˜×•×‘×™× ğŸŒŸ</div></div>
      <div class="stat-card"><div class="stat-number" id="statStreak">0</div><div class="stat-label">×™××™ ×¨×¦×£ ğŸ”¥</div></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ”” ×ª×–×›×•×¨×•×ª ×”×©×‘×•×¢</div>
      <div id="todayReminders"><div class="empty-state"><div class="empty-icon">ğŸ˜Œ</div><p>××™×Ÿ ×ª×–×›×•×¨×•×ª ×“×—×•×¤×•×ª</p></div></div>
    </div>
    <div class="review-section" id="eveningReview" style="display:none;">
      <div class="review-title">ğŸŒ™ ×¡×™×›×•× ×™×•×</div>
      <div style="font-size:14px;line-height:1.7;margin-bottom:14px;">×›×œ ×”×›×‘×•×“! ×‘×•× × ×¡×›× ××ª ×”×™×•× ×•× ×›×™×Ÿ ××ª ××—×¨.</div>
      <button class="btn btn-primary" onclick="openModal('eveningModal')">×›×ª×•×‘ ×¡×™×›×•× ×™×•×</button>
    </div>
    <div class="review-section" id="weeklyReviewPrompt" style="display:none;">
      <div class="review-title">ğŸ“… ×©×‘×ª â€” ×¡×™×›×•× ×©×‘×•×¢×™</div>
      <div style="font-size:14px;margin-bottom:14px;">×©×‘×ª ×©×œ×•×! ×”×’×™×¢ ×”×–××Ÿ ×œ×¡×›× ××ª ×”×©×‘×•×¢ ×•×œ×ª×›× ×Ÿ ××ª ×”×‘×.</div>
      <button class="btn btn-primary" onclick="openModal('weeklyModal')">×”×ª×—×œ ×¡×™×›×•× ×©×‘×•×¢×™</button>
    </div>
  </div>

  <!-- TASKS PANEL -->
  <div id="panel-tasks" class="panel">
    <div class="card">
      <div class="card-title">â• ××©×™××” ×—×“×©×”</div>
      <div class="form-row"><input type="text" id="taskName" placeholder="×©× ×”××©×™××”..." /></div>
      <div class="form-grid">
        <div><label class="form-label">×–××Ÿ ××•×¢×¨×š (×“×§')</label><input type="text" id="taskDuration" placeholder="30" /></div>
        <div><label class="form-label">×¢×“×™×¤×•×ª</label>
          <select id="taskPriority"><option value="high">ğŸ”´ ×’×‘×•×”×”</option><option value="medium" selected>ğŸŸ¡ ×‘×™× ×•× ×™×ª</option><option value="low">ğŸŸ¢ × ××•×›×”</option></select>
        </div>
        <div><label class="form-label">×§×˜×’×•×¨×™×”</label>
          <select id="taskCategory"><option>×¢×‘×•×“×”</option><option>××©×¤×—×”</option><option>××™×©×™</option><option>×‘×¨×™××•×ª</option><option>×›×¡×¤×™×</option><option>××—×¨</option></select>
        </div>
        <div><label class="form-label">×ª××¨×™×š ×™×¢×“</label><input type="date" id="taskDate" /></div>
      </div>
      <button class="btn btn-primary" onclick="addTask()" style="width:100%;">×”×•×¡×£ ××©×™××”</button>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">
      <button class="btn btn-sm" style="background:var(--surface2);" onclick="filterTasks('all')">×”×›×œ</button>
      <button class="btn btn-sm" style="background:var(--surface2);" onclick="filterTasks('pending')">×××ª×™× ×•×ª</button>
      <button class="btn btn-sm" style="background:var(--surface2);" onclick="filterTasks('done')">×”×•×©×œ××•</button>
      <button class="btn btn-sm btn-gold" onclick="filterTasks('high')">ğŸ”´ ×“×—×•×£</button>
    </div>
    <div id="taskList"><div class="empty-state"><div class="empty-icon">ğŸ“</div><p>×”×•×¡×£ ××ª ×”××©×™××” ×”×¨××©×•× ×”!</p></div></div>
  </div>

  <!-- SCHEDULE PANEL -->
  <div id="panel-schedule" class="panel">
    <div class="card">
      <div class="card-title">â° ×”×’×“×¨ ×œ×•×— ×–×× ×™×</div>
      <div class="form-row"><input type="text" id="scheduleTask" placeholder="×©× ×”×¤×¢×™×œ×•×ª..." /></div>
      <div class="form-grid">
        <div><label class="form-label">×©×¢×ª ×”×ª×—×œ×”</label><input type="time" id="scheduleStart" /></div>
        <div><label class="form-label">×©×¢×ª ×¡×™×•×</label><input type="time" id="scheduleEnd" /></div>
      </div>
      <div class="form-row"><label class="form-label">×”×¤×¡×§×” ××—×¨×™ (×“×§×•×ª)</label><input type="text" id="scheduleBreak" placeholder="0 = ×œ×œ× ×”×¤×¡×§×”" /></div>
      <button class="btn btn-primary" onclick="addScheduleItem()" style="width:100%;">×”×•×¡×£ ×œ×œ×•×—</button>
    </div>
    <div class="section-divider">×œ×•×— ×–×× ×™× ×”×™×•×</div>
    <div id="scheduleList"><div class="empty-state"><div class="empty-icon">â³</div><p>×œ×•×— ×”×–×× ×™× ×¨×™×§</p></div></div>
  </div>

  <!-- REMINDERS PANEL -->
  <div id="panel-reminders" class="panel">
    <div class="card">
      <div class="card-title">ğŸ”” ×ª×–×›×•×¨×ª ×—×“×©×”</div>
      <div class="form-row"><input type="text" id="reminderTitle" placeholder="×ª×™××•×¨ ×”×ª×–×›×•×¨×ª..." /></div>
      <div class="form-grid">
        <div><label class="form-label">×ª××¨×™×š</label><input type="date" id="reminderDate" /></div>
        <div><label class="form-label">×§×˜×’×•×¨×™×”</label>
          <select id="reminderType">
            <option value="couple">ğŸ’‘ ×–×•×’×™×•×ª</option>
            <option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ×™×œ×“×™×/××©×¤×—×”</option>
            <option value="work">ğŸ’¼ ×¢×‘×•×“×”/×¤×’×™×©×•×ª</option>
            <option value="friends">ğŸ‘¥ ×—×‘×¨×™×</option>
            <option value="personal">â­ ××™×©×™</option>
          </select>
        </div>
      </div>
      <div class="form-row"><label class="form-label">×ª×“×™×¨×•×ª</label>
        <select id="reminderRecurrence">
          <option value="once">×¤×¢× ××—×ª</option>
          <option value="weekly">×›×œ ×©×‘×•×¢</option>
          <option value="monthly">×›×œ ×—×•×“×©</option>
          <option value="yearly">×›×œ ×©× ×”</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="addReminder()" style="width:100%;">×”×•×¡×£ ×ª×–×›×•×¨×ª</button>
    </div>
    <div class="section-divider">×›×œ ×”×ª×–×›×•×¨×•×ª</div>
    <div id="reminderList"><div class="empty-state"><div class="empty-icon">ğŸ’­</div><p>×”×•×¡×£ ×ª×–×›×•×¨×•×ª ×—×©×•×‘×•×ª</p></div></div>
  </div>

  <!-- GROWTH PANEL -->
  <div id="panel-growth" class="panel">
    <!-- Meditation -->
    <div class="card">
      <div class="card-title">ğŸ§˜ ××“×™×˜×¦×™×” ×•×“××™×•×Ÿ ××•×“×¨×š</div>
      <div style="text-align:center;padding:8px 0;">
        <div class="meditation-ring">
          <svg viewBox="0 0 116 116"><circle cx="58" cy="58" r="55" id="medCircle" stroke-dasharray="346" stroke-dashoffset="346"/></svg>
          <span id="medTimer">5:00</span>
        </div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:10px;" id="medText">×‘×—×¨ ××©×š ×–××Ÿ</div>
        <div style="display:flex;gap:6px;justify-content:center;margin-bottom:12px;">
          <button class="btn btn-sm" style="background:var(--surface2);" onclick="setMedTime(5)">5 ×“×§'</button>
          <button class="btn btn-sm" style="background:var(--surface2);" onclick="setMedTime(10)">10 ×“×§'</button>
          <button class="btn btn-sm" style="background:var(--surface2);" onclick="setMedTime(15)">15 ×“×§'</button>
          <button class="btn btn-sm" style="background:var(--surface2);" onclick="setMedTime(20)">20 ×“×§'</button>
        </div>
        <button class="btn btn-primary" id="medBtn" onclick="toggleMeditation()">â–¶ ×”×ª×—×œ ××“×™×˜×¦×™×”</button>
      </div>
    </div>

    <!-- Daily good deed -->
    <div class="card">
      <div class="card-title">ğŸŒŸ ××¢×©×” ×˜×•×‘ ×™×•××™</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:12px;">×œ×¤×—×•×ª ×¤×¢×•×œ×” ××—×ª ×˜×•×‘×” ×‘×™×•× â€” ×œ× ×œ××™×“×”, ××œ× ××¢×©×”!</div>
      <div id="dailyGoodDeeds">
        <div class="growth-item" onclick="toggleGoodDeed(0)"><span class="growth-icon">ğŸ˜Š</span><div class="growth-text"><div class="growth-title">×”×§×©×‘×ª ×œ××—×“ ×‘×¡×‘×™×‘×ª×š</div><div class="growth-desc">×ª×©×•××ª ×œ×‘ ××œ××” ×œ××™×©×”×• ×©×¦×¨×™×š</div></div><span id="deed-0">â¬œ</span></div>
        <div class="growth-item" onclick="toggleGoodDeed(1)"><span class="growth-icon">ğŸ¤—</span><div class="growth-text"><div class="growth-title">×¢×©×™×ª ×˜×•×‘ ×œ××—×¨</div><div class="growth-desc">×¤×¢×•×œ×” ×§×˜× ×” ×©×¢×–×¨×” ×œ××™×©×”×•</div></div><span id="deed-1">â¬œ</span></div>
        <div class="growth-item" onclick="toggleGoodDeed(2)"><span class="growth-icon">ğŸ’ª</span><div class="growth-text"><div class="growth-title">×××¨×ª ××©×”×• ××¢×¦×™×</div><div class="growth-desc">××—×××”, ×¢×™×“×•×“, ×”×›×¨×ª ×ª×•×“×”</div></div><span id="deed-2">â¬œ</span></div>
      </div>
      <div style="margin-top:10px;">
        <input type="text" id="customDeed" placeholder="×”×•×¡×£ ××¢×©×” ×˜×•×‘ ××©×œ×š..." />
        <button class="btn btn-success" onclick="addCustomDeed()" style="width:100%;margin-top:8px;">âœ¨ ×”×•×¡×£ ×•××©×¨</button>
      </div>
    </div>

    <!-- Weekly contribution -->
    <div class="card">
      <div class="card-title">ğŸŒ ×ª×¨×•××” ×©×‘×•×¢×™×ª ×œ×¡×‘×™×‘×”/×—×‘×¨×”</div>
      <div class="streak-display">
        <span style="font-size:34px;">ğŸ”¥</span>
        <div><div class="streak-count" id="contribStreak">0</div><div class="streak-text">×©×‘×•×¢×•×ª ×¨×¦×£ ×©×œ ×ª×¨×•××”</div></div>
      </div>
      <div id="weeklyContributions">
        <div class="growth-item" onclick="toggleContrib(0)"><span class="growth-icon">â™»ï¸</span><div class="growth-text"><div class="growth-title">××—×–×•×¨ / ×”×¤×—×ª×ª ×¤×¡×•×œ×ª</div></div><span id="contrib-0">â¬œ</span></div>
        <div class="growth-item" onclick="toggleContrib(1)"><span class="growth-icon">ğŸ¤</span><div class="growth-text"><div class="growth-title">×”×ª× ×“×‘×•×ª / ×¢×–×¨×” ×œ×§×”×™×œ×”</div></div><span id="contrib-1">â¬œ</span></div>
        <div class="growth-item" onclick="toggleContrib(2)"><span class="growth-icon">ğŸŒ±</span><div class="growth-text"><div class="growth-title">×¤×¢×•×œ×” ×œ×¡×‘×™×‘×”</div></div><span id="contrib-2">â¬œ</span></div>
      </div>
      <div style="margin-top:10px;">
        <input type="text" id="customContrib" placeholder="×ª×¨×•××” ×©×‘×•×¢×™×ª ××©×œ×š..." />
        <button class="btn btn-success" onclick="addCustomContrib()" style="width:100%;margin-top:8px;">ğŸŒ ×”×•×¡×£ ×ª×¨×•××”</button>
      </div>
    </div>
  </div>

  <!-- REPORT PANEL -->
  <div id="panel-report" class="panel">
    <div class="card">
      <div class="card-title">ğŸ“Š ×“×•×— ×©×‘×•×¢×™</div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-number" id="reportCompleted">-</div><div class="stat-label">××©×™××•×ª ×”×•×©×œ××•</div></div>
        <div class="stat-card"><div class="stat-number" id="reportEfficiency">-</div><div class="stat-label">×™×¢×™×œ×•×ª %</div></div>
        <div class="stat-card"><div class="stat-number" id="reportDeeds">-</div><div class="stat-label">××¢×©×™× ×˜×•×‘×™×</div></div>
        <div class="stat-card"><div class="stat-number" id="reportContribs">-</div><div class="stat-label">×ª×¨×•××•×ª</div></div>
      </div>
      <div class="report-section report-good"><h4>âœ… ××” ×”×œ×š ×˜×•×‘ ×”×©×‘×•×¢</h4><ul id="reportGood"></ul></div>
      <div class="report-section report-improve"><h4>ğŸ’¡ ××–×•×¨×™× ×œ×©×™×¤×•×¨</h4><ul id="reportImprove"></ul></div>
      <div class="card" style="background:var(--surface2);margin-top:12px;">
        <div class="card-title" style="font-size:14px;">ğŸ“ ×”×¨×”×•×¨×™× ×©×‘×•×¢×™×™×</div>
        <textarea id="weeklyNotes" placeholder="×ª×•×‘× ×•×ª ×œ×©×‘×•×¢ ×©×¢×‘×¨ ×•××˜×¨×•×ª ×œ×©×‘×•×¢ ×”×‘×..."></textarea>
        <button class="btn btn-primary" onclick="saveNotes()" style="width:100%;margin-top:8px;">×©××•×¨</button>
      </div>
    </div>
  </div>
</div>

<!-- ×›×¨×˜×™×¡ ×©×™×—×” ×§×•×œ×™×ª -->
<div class="voice-conv-card" id="voiceConvCard">
  <div class="voice-conv-waves">
    <span></span><span></span><span></span><span></span><span></span>
  </div>
  <div class="voice-conv-text" id="voiceConvText">×××–×™×Ÿ...</div>
  <div class="voice-conv-hint">×œ×—×¥ ×©×•×‘ ×¢×œ ×”××™×§×¨×•×¤×•×Ÿ ×œ×¢×¦×™×¨×”</div>
</div>

<!-- Voice FAB -->
<div class="voice-fab">
  <div class="transcript-bar" id="transcriptBar">×××–×™×Ÿ...</div>
  <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">ğŸ¤</button>
  <div class="voice-label" id="voiceLabel">×œ×—×¥ ×œ×“×™×‘×•×¨</div>
</div>

<div class="notification" id="notification"></div>

<!-- Task Details Modal -->
<div class="modal-overlay" id="taskDetailsModal">
  <div class="modal">
    <div class="modal-title">â• <span id="taskModalName"></span></div>
    <div class="form-row">
      <label class="form-label">ğŸ“… ×œ××ª×™ ×”××©×™××”?</label>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <button class="btn btn-sm" style="background:var(--surface2);" onclick="setQuickDate('today')">×”×™×•×</button>
        <button class="btn btn-sm" style="background:var(--surface2);" onclick="setQuickDate('tomorrow')">××—×¨</button>
        <button class="btn btn-sm" style="background:var(--surface2);" onclick="setQuickDate('week')">×¡×•×£ ×”×©×‘×•×¢</button>
      </div>
      <input type="date" id="modalTaskDate" />
    </div>
    <div class="form-row">
      <label class="form-label">ğŸ‘¤ ××™ ×§×©×•×¨ ×œ××©×™××”?</label>
      <input type="text" id="modalTaskPeople" placeholder="×œ×“×•×’××”: ××©×ª×™, ×”×‘×•×¡, ×“× ×™..." />
    </div>
    <div class="form-row">
      <label class="form-label">ğŸ”” ××ª×™ ×œ×”×ª×¨×™×¢?</label>
      <select id="modalTaskReminder" onchange="toggleReminderTime(this.value)">
        <option value="">×œ×œ× ×”×ª×¨××”</option>
        <option value="same">×‘××•×ª×• ×™×•× ×‘×‘×•×§×¨ (09:00)</option>
        <option value="day_before">×™×•× ×œ×¤× ×™ ×‘×‘×•×§×¨ (09:00)</option>
        <option value="week_before">×©×‘×•×¢ ×œ×¤× ×™</option>
        <option value="custom">×©×¢×” ×¡×¤×¦×™×¤×™×ª</option>
      </select>
      <input type="time" id="modalTaskReminderTime" style="display:none;margin-top:8px;" />
    </div>
    <div class="form-row">
      <label class="form-label">âš¡ ×¢×“×™×¤×•×ª</label>
      <select id="modalTaskPriority">
        <option value="high">ğŸ”´ ×’×‘×•×”×”</option>
        <option value="medium" selected>ğŸŸ¡ ×‘×™× ×•× ×™×ª</option>
        <option value="low">ğŸŸ¢ × ××•×›×”</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveTaskFromModal()">âœ… ×©××•×¨ ××©×™××”</button>
      <button class="btn" style="background:var(--surface2);" onclick="closeModal('taskDetailsModal')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- Gratitude Modal -->
<div class="modal-overlay" id="gratitudeModal">
  <div class="modal">
    <div class="modal-title">ğŸ™ ×”×›×¨×ª ×ª×•×“×” â€” ×‘×•×§×¨ ×˜×•×‘</div>
    <p style="font-size:14px;color:var(--muted);margin-bottom:14px;">×§×— ×¨×’×¢ ×œ× ×©×•×... ×¢×œ ××” ××ª×” ××¡×™×¨ ×ª×•×“×” ×”×‘×•×§×¨?</p>
    <div class="form-row"><textarea id="gratitudeText" placeholder="3 ×“×‘×¨×™× ×©×× ×™ ××¡×™×¨ ×ª×•×“×” ×¢×œ×™×”×..." style="height:110px;"></textarea></div>
    <div class="form-row">
      <label class="form-label">âœ¨ ×›×•×•× ×” ×œ×™×•×</label>
      <input type="text" id="intentionText" placeholder="×”×›×•×•× ×” ×©×œ×™ ×œ×™×•× ×–×”..." />
    </div>
    <div class="modal-actions">
      <button class="btn btn-gold" onclick="saveGratitude()">×©××•×¨ âœ¨</button>
      <button class="btn" style="background:var(--surface2);" onclick="closeModal('gratitudeModal')">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<!-- Evening Modal -->
<div class="modal-overlay" id="eveningModal">
  <div class="modal">
    <div class="modal-title">ğŸŒ™ ×¡×™×›×•× ×™×•× â€” ×œ×§×¨××ª ××—×¨</div>
    <div class="form-row"><label class="form-label">ğŸŒŸ ×”×¨×’×¢ ×”×˜×•×‘ ×‘×™×•×</label><input type="text" id="eveningBest" placeholder="××” ×”×™×” ×”×›×™ ×˜×•×‘?" /></div>
    <div class="form-row"><label class="form-label">ğŸ”§ ××” ××©×¤×¨ ××—×¨?</label><input type="text" id="eveningImprove" placeholder="××” ××¤×©×¨ ×œ×©×¤×¨?" /></div>
    <div class="form-row"><label class="form-label">ğŸ“Œ 3 ××©×™××•×ª ×œ×ª×—×™×œ×ª ××—×¨</label><textarea id="eveningTomorrow" placeholder="×”××©×™××•×ª ×”×›×™ ×—×©×•×‘×•×ª ×œ××—×¨..." style="height:80px;"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveEveningReview()">×©××•×¨ ğŸŒ™</button>
      <button class="btn" style="background:var(--surface2);" onclick="closeModal('eveningModal')">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<!-- Weekly Modal -->
<div class="modal-overlay" id="weeklyModal">
  <div class="modal">
    <div class="modal-title">ğŸ“… ×¡×™×›×•× ×©×‘×•×¢×™</div>
    <div class="form-row"><label class="form-label">ğŸ¯ ××” ×”×©×’×ª×™ ×”×©×‘×•×¢?</label><textarea id="weeklyAchieve" style="height:70px;" placeholder="×”×™×©×’×™× ××¨×›×–×™×™×..."></textarea></div>
    <div class="form-row"><label class="form-label">ğŸ’¡ ××” ×œ××“×ª×™ ×¢×œ ×¢×¦××™?</label><textarea id="weeklyLearn" style="height:70px;" placeholder="×ª×•×‘× ×•×ª ××™×©×™×•×ª..."></textarea></div>
    <div class="form-row"><label class="form-label">ğŸš€ 3 ××˜×¨×•×ª ×œ×©×‘×•×¢ ×”×‘×</label><textarea id="weeklyGoals" style="height:70px;" placeholder="××˜×¨×•×ª ×œ×©×‘×•×¢ ×”×‘×..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveWeeklyReview()">×©××•×¨ ğŸ“…</button>
      <button class="btn" style="background:var(--surface2);" onclick="closeModal('weeklyModal')">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let data = JSON.parse(localStorage.getItem('pa2') || '{}');
const DEF = { tasks:[], schedule:[], reminders:[], deedsDone:[], contribsDone:[], streak:0, contribStreak:0, lastDay:'', weeklyNotes:'' };
Object.keys(DEF).forEach(k => { if (data[k] == null) data[k] = DEF[k]; });
function save() { localStorage.setItem('pa2', JSON.stringify(data)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PWA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  if (!localStorage.getItem('pwaInstallDismissed')) {
    document.getElementById('installBanner').classList.add('show');
  }
});
function installPWA() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => {
      deferredPrompt = null;
      document.getElementById('installBanner').classList.remove('show');
    });
  }
}
function dismissInstall() {
  localStorage.setItem('pwaInstallDismissed', '1');
  document.getElementById('installBanner').classList.remove('show');
}

// Register Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportData() {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const d = new Date().toISOString().split('T')[0];
  a.href = url;
  a.download = `×¢×•×–×¨-××™×©×™-×’×™×‘×•×™-${d}.json`;
  a.click();
  URL.revokeObjectURL(url);
  notify('ğŸ“¤ ×”× ×ª×•× ×™× ×’×•×‘×• ×‘×”×¦×œ×—×”!');
}

function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (imported.tasks !== undefined) {
        data = { ...DEF, ...imported };
        save();
        renderAll();
        notify('ğŸ“¥ ×”× ×ª×•× ×™× ×©×•×—×–×¨×• ×‘×”×¦×œ×—×”!');
      } else {
        notify('âš ï¸ ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ');
      }
    } catch { notify('âš ï¸ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT & CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const QUOTES = [
  '"×”×™×•× ×”×•× ××ª× ×” â€” ×œ×›×Ÿ ×”×•× × ×§×¨× ×´×”×•×•×”×´"',
  '"×›×œ ××¡×¢ ××ª×—×™×œ ×‘×¦×¢×“ ××—×“"',
  '"××” ×©××ª×” ××ª××§×“ ×‘×• â€” ××ª×¨×—×‘"',
  '"×”×¦×œ×—×” ×”×™× ×¡×›×•× ×©×œ ××××¦×™× ×§×˜× ×™×, ×™×•×-×™×•×"',
  '"×‘×›×œ ×™×•× ×™×© ×”×–×“×× ×•×ª ×œ×”×™×•×ª ×’×¨×¡×” ×˜×•×‘×” ×™×•×ª×¨"',
  '"×”×›×¨×ª ×ª×•×“×” ×”×™× ×”×“×¨×š ×”×§×¦×¨×” ×‘×™×•×ª×¨ ×œ××•×©×¨"',
  '"××œ ×ª×“×—×” ×œ×”×™×•×ª ×˜×•×‘"',
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ×—×™×‘×•×¨ ×œ×©×¨×ª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SERVER_URL = 'https://personal-assistant-server-production-d594.up.railway.app';
const VAPID_PUBLIC_KEY = 'BGNNqPpUROGAqlsbGYVOrIU1k2HAG2Jpi2SEZocLYJ_EDWwBpzPmOgWeiH6jp09ABB9zX1P98QpBeHAQFtcM5e4';

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
}

async function registerPush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
  try {
    const reg = await navigator.serviceWorker.ready;
    let sub = await reg.pushManager.getSubscription();
    if (!sub) {
      sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
      });
    }
    await fetch(SERVER_URL + '/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(sub)
    });
    console.log('âœ… ×”×ª×¨××•×ª ×¤×•×© ×¨×©×•××•×ª');
  } catch (e) {
    console.log('Push registration failed:', e);
  }
}

async function saveGratitudeToServer(text) {
  try {
    await fetch(SERVER_URL + '/gratitude', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, date: new Date().toISOString() })
    });
  } catch (e) {
    console.log('Gratitude save failed:', e);
  }
}

async function loadCalendarEvents() {
  try {
    const res = await fetch(SERVER_URL + '/calendar/today');
    const { events } = await res.json();
    return events || [];
  } catch (e) {
    return [];
  }
}

function init() {
  updateClock();
  setInterval(updateClock, 1000);
  setDailyQuote();
  checkDailyReset();
  renderAll();
  // ×¨×™×©×•× ×œ×”×ª×¨××•×ª ×¤×•×©
  setTimeout(registerPush, 2000);
}

function updateClock() {
  const now = new Date();
  const hh = now.getHours().toString().padStart(2,'0');
  const mm = now.getMinutes().toString().padStart(2,'0');
  document.getElementById('currentTime').textContent = hh + ':' + mm;

  const days = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
  const months = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
  document.getElementById('currentDate').textContent = `×™×•× ${days[now.getDay()]} | ${now.getDate()} ${months[now.getMonth()]}`;

  const h = now.getHours();
  document.getElementById('headerGreeting').textContent =
    h < 12 ? 'â˜€ï¸ ×‘×•×§×¨ ×˜×•×‘!' : h < 17 ? 'ğŸŒ¤ï¸ ×¦×”×¨×™×™× ×˜×•×‘×™×!' : h < 21 ? 'ğŸŒ… ×¢×¨×‘ ×˜×•×‘!' : 'ğŸŒ™ ×œ×™×œ×” ×˜×•×‘!';

  // Evening review
  const er = document.getElementById('eveningReview');
  if (er) er.style.display = h >= 21 ? 'block' : 'none';

  // Weekly review (Saturday = 6)
  const wr = document.getElementById('weeklyReviewPrompt');
  if (wr) wr.style.display = now.getDay() === 6 ? 'block' : 'none';
}

function setDailyQuote() {
  document.getElementById('dailyQuote').textContent = QUOTES[new Date().getDay() % QUOTES.length];
}

function checkDailyReset() {
  const today = new Date().toDateString();
  if (data.lastDay !== today) {
    data.lastDay = today;
    data.deedsDone = [];
    save();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
  renderTasks();
  renderSchedule();
  renderReminders();
  renderTodayStats();
  renderTodayReminders();
  renderReport();
  renderDeedsState();
  renderContribState();
  if (data.weeklyNotes) document.getElementById('weeklyNotes').value = data.weeklyNotes;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  btn.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let taskFilter = 'all';

// ××©×™××” ×–×× ×™×ª ×‘×”××ª× ×” ×œ×¤×¨×˜×™×
let pendingTask = null;

function addTask() {
  const name = document.getElementById('taskName').value.trim();
  if (!name) { notify('×”×›× ×¡ ×©× ×œ××©×™××”'); return; }
  openTaskDetailsModal(name, {
    duration: document.getElementById('taskDuration').value || '30',
    category: document.getElementById('taskCategory').value
  });
  document.getElementById('taskName').value = '';
  document.getElementById('taskDuration').value = '';
}

function openTaskDetailsModal(name, extras) {
  pendingTask = { name, ...extras };
  document.getElementById('taskModalName').textContent = name;
  document.getElementById('modalTaskDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('modalTaskPeople').value = '';
  document.getElementById('modalTaskReminder').value = '';
  document.getElementById('modalTaskReminderTime').style.display = 'none';
  document.getElementById('modalTaskPriority').value = 'medium';
  openModal('taskDetailsModal');
}

function setQuickDate(when) {
  const d = new Date();
  if (when === 'tomorrow') d.setDate(d.getDate() + 1);
  else if (when === 'week') {
    const day = d.getDay();
    const daysUntilFri = day <= 5 ? 5 - day : 6;
    d.setDate(d.getDate() + daysUntilFri);
  }
  document.getElementById('modalTaskDate').value = d.toISOString().split('T')[0];
}

function toggleReminderTime(val) {
  document.getElementById('modalTaskReminderTime').style.display = val === 'custom' ? 'block' : 'none';
}

function saveTaskFromModal() {
  if (!pendingTask) return;
  const date = document.getElementById('modalTaskDate').value;
  const people = document.getElementById('modalTaskPeople').value.trim();
  const reminder = document.getElementById('modalTaskReminder').value;
  const reminderTime = document.getElementById('modalTaskReminderTime').value;
  const priority = document.getElementById('modalTaskPriority').value;

  // ×—×™×©×•×‘ ×ª××¨×™×š ×”×ª×¨××”
  let alertDate = '';
  if (reminder === 'same') alertDate = date;
  else if (reminder === 'day_before') {
    const d = new Date(date); d.setDate(d.getDate() - 1);
    alertDate = d.toISOString().split('T')[0];
  } else if (reminder === 'week_before') {
    const d = new Date(date); d.setDate(d.getDate() - 7);
    alertDate = d.toISOString().split('T')[0];
  }

  data.tasks.unshift({
    id: Date.now(),
    name: pendingTask.name,
    duration: pendingTask.duration || '30',
    category: pendingTask.category || '××—×¨',
    priority,
    date,
    people,
    reminder,
    reminderTime,
    alertDate,
    done: false
  });

  pendingTask = null;
  save(); renderTasks(); renderTodayStats();
  closeModal('taskDetailsModal');
  notify('âœ… ××©×™××” × ×•×¡×¤×”!');
}

function reminderLabel(r) {
  if (r === 'same') return '×‘××•×ª×• ×™×•×';
  if (r === 'day_before') return '×™×•× ×œ×¤× ×™';
  if (r === 'week_before') return '×©×‘×•×¢ ×œ×¤× ×™';
  if (r === 'custom') return '×©×¢×” ×¡×¤×¦×™×¤×™×ª';
  return '';
}

function toggleTask(id) {
  const t = data.tasks.find(t => t.id === id);
  if (t) { t.done = !t.done; save(); renderTasks(); renderTodayStats(); if (t.done) notify('ğŸ‰ ×›×œ ×”×›×‘×•×“!'); }
}

function deleteTask(id) { data.tasks = data.tasks.filter(t => t.id !== id); save(); renderTasks(); renderTodayStats(); }
function filterTasks(f) { taskFilter = f; renderTasks(); }

function renderTasks() {
  const list = document.getElementById('taskList');
  let tasks = [...data.tasks];
  if (taskFilter === 'pending') tasks = tasks.filter(t => !t.done);
  else if (taskFilter === 'done') tasks = tasks.filter(t => t.done);
  else if (taskFilter === 'high') tasks = tasks.filter(t => t.priority === 'high');
  const po = { high:0, medium:1, low:2 };
  tasks.sort((a,b) => { if (a.done !== b.done) return a.done ? 1 : -1; return po[a.priority]-po[b.priority]; });
  if (!tasks.length) { list.innerHTML = '<div class="empty-state"><div class="empty-icon">âœ¨</div><p>××™×Ÿ ××©×™××•×ª ×œ×”×¦×™×’</p></div>'; return; }
  list.innerHTML = tasks.map(t => `
    <div class="task-item priority-${t.priority} ${t.done?'done':''}">
      <div class="task-check ${t.done?'checked':''}" onclick="toggleTask(${t.id})">${t.done?'âœ“':''}</div>
      <div class="task-info">
        <div class="task-name">${t.name}</div>
        <div class="task-meta">
          <span class="badge badge-purple">â±ï¸ ${t.duration} ×“×§'</span>
          <span class="badge badge-gold">ğŸ“ ${t.category}</span>
          ${t.date ? `<span class="badge" style="background:var(--surface);color:var(--muted)">ğŸ“… ${t.date}</span>` : ''}
          ${t.people ? `<span class="badge" style="background:rgba(16,185,129,0.15);color:#6ee7b7">ğŸ‘¤ ${t.people}</span>` : ''}
          ${t.reminder && t.reminder !== '' ? `<span class="badge" style="background:rgba(245,158,11,0.15);color:var(--gold)">ğŸ”” ${reminderLabel(t.reminder)}</span>` : ''}
        </div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="deleteTask(${t.id})">ğŸ—‘ï¸</button>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCHEDULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addScheduleItem() {
  const name = document.getElementById('scheduleTask').value.trim();
  const start = document.getElementById('scheduleStart').value;
  if (!name || !start) { notify('××œ× ×©× ×•×©×¢×ª ×”×ª×—×œ×”'); return; }
  data.schedule.push({ id: Date.now(), name, start, end: document.getElementById('scheduleEnd').value || '', breakAfter: document.getElementById('scheduleBreak').value || 0 });
  data.schedule.sort((a,b) => a.start.localeCompare(b.start));
  save(); renderSchedule();
  document.getElementById('scheduleTask').value = '';
  document.getElementById('scheduleStart').value = '';
  document.getElementById('scheduleEnd').value = '';
  document.getElementById('scheduleBreak').value = '';
  notify('â° × ×•×¡×£ ×œ×œ×•×— ×”×–×× ×™×!');
}
function deleteScheduleItem(id) { data.schedule = data.schedule.filter(s => s.id !== id); save(); renderSchedule(); }

function renderSchedule() {
  const list = document.getElementById('scheduleList');
  if (!data.schedule.length) { list.innerHTML = '<div class="empty-state"><div class="empty-icon">â³</div><p>×œ×•×— ×”×–×× ×™× ×¨×™×§</p></div>'; return; }
  const now = new Date(); const nowMin = now.getHours()*60+now.getMinutes();
  list.innerHTML = data.schedule.map(s => {
    const [sh,sm] = s.start.split(':').map(Number);
    const isCurrent = s.end ? (() => { const [eh,em]=s.end.split(':').map(Number); return nowMin>=sh*60+sm && nowMin<=eh*60+em; })() : false;
    return `<div class="schedule-slot" style="${isCurrent?'border:1px solid var(--accent);box-shadow:0 0 10px var(--glow);':''}">
      <div class="slot-time"><div>${s.start}</div>${s.end?`<div style="color:var(--muted)">â†“${s.end}</div>`:''}</div>
      <div class="slot-bar"></div>
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:600;">${isCurrent?'ğŸŸ¢ ':''}${s.name}</div>
        ${s.breakAfter>0?`<div style="font-size:12px;color:var(--gold);">â˜• ×”×¤×¡×§×” ${s.breakAfter} ×“×§'</div>`:''}
      </div>
      <button class="btn btn-danger btn-sm" onclick="deleteScheduleItem(${s.id})">âœ•</button>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REMINDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RICONS = { couple:'ğŸ’‘', family:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', work:'ğŸ’¼', friends:'ğŸ‘¥', personal:'â­' };
const RTAGS  = { couple:'tag-couple', family:'tag-family', work:'tag-work', friends:'tag-friends', personal:'tag-personal' };

function getDaysUntil(d) {
  if (!d) return null;
  const today = new Date(); today.setHours(0,0,0,0);
  const tgt = new Date(d); tgt.setHours(0,0,0,0);
  return Math.round((tgt-today)/(864e5));
}

function addReminder() {
  const title = document.getElementById('reminderTitle').value.trim();
  if (!title) { notify('×”×›× ×¡ ×ª×™××•×¨ ×œ×ª×–×›×•×¨×ª'); return; }
  data.reminders.push({ id: Date.now(), title, date: document.getElementById('reminderDate').value, type: document.getElementById('reminderType').value, recurrence: document.getElementById('reminderRecurrence').value });
  data.reminders.sort((a,b)=>(a.date||'').localeCompare(b.date||''));
  save(); renderReminders(); renderTodayReminders();
  document.getElementById('reminderTitle').value = '';
  document.getElementById('reminderDate').value = '';
  notify('ğŸ”” ×ª×–×›×•×¨×ª × ×•×¡×¤×”!');
}
function deleteReminder(id) { data.reminders = data.reminders.filter(r=>r.id!==id); save(); renderReminders(); renderTodayReminders(); }

function daysText(days) {
  if (days === null) return '';
  if (days === 0) return '<span style="color:var(--red);font-weight:700;">×”×™×•×!</span>';
  if (days === 1) return '<span style="color:var(--gold);">××—×¨</span>';
  if (days > 0) return `<span style="color:var(--accent2);">×‘×¢×•×“ ${days} ×™××™×</span>`;
  return `<span style="color:var(--muted);">×¢×‘×¨ ×œ×¤× ×™ ${-days} ×™××™×</span>`;
}

function renderReminders() {
  const list = document.getElementById('reminderList');
  if (!data.reminders.length) { list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ’­</div><p>×”×•×¡×£ ×ª×–×›×•×¨×•×ª ×—×©×•×‘×•×ª</p></div>'; return; }
  list.innerHTML = data.reminders.map(r => {
    const days = getDaysUntil(r.date);
    return `<div class="reminder-item">
      <div class="reminder-icon">${RICONS[r.type]||'ğŸ””'}</div>
      <div class="reminder-info">
        <div class="reminder-title">${r.title}</div>
        <div style="display:flex;gap:6px;align-items:center;margin-top:3px;flex-wrap:wrap;">
          <span class="badge ${RTAGS[r.type]||'badge-purple'}">${r.type}</span>
          ${r.date?`<span style="font-size:12px;color:var(--muted);">${r.date}</span>`:''}
          ${daysText(days)}
          ${r.recurrence!=='once'?`<span class="badge badge-green">${r.recurrence}</span>`:''}
        </div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="deleteReminder(${r.id})">âœ•</button>
    </div>`;
  }).join('');
}

function renderTodayReminders() {
  const c = document.getElementById('todayReminders');
  const upcoming = data.reminders.filter(r => { const d=getDaysUntil(r.date); return d!==null && d>=0 && d<=7; }).slice(0,5);
  if (!upcoming.length) { c.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ˜Œ</div><p>××™×Ÿ ×ª×–×›×•×¨×•×ª ×”×©×‘×•×¢</p></div>'; return; }
  c.innerHTML = upcoming.map(r => {
    const d = getDaysUntil(r.date);
    return `<div class="reminder-item"><div class="reminder-icon">${RICONS[r.type]||'ğŸ””'}</div><div class="reminder-info"><div class="reminder-title">${r.title}</div><div style="font-size:12px;color:var(--gold);margin-top:2px;">${d===0?'×”×™×•×!':d===1?'××—×¨':`×‘×¢×•×“ ${d} ×™××™×`}</div></div></div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TODAY STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTodayStats() {
  const today = new Date().toISOString().split('T')[0];
  const todayTasks = data.tasks.filter(t => t.date === today || !t.date);
  const done = todayTasks.filter(t => t.done).length;
  const total = todayTasks.length;
  document.getElementById('statDone').textContent = done;
  document.getElementById('statTotal').textContent = total;
  document.getElementById('progressFill').style.width = (total>0 ? Math.round(done/total*100) : 0) + '%';
  document.getElementById('statStreak').textContent = data.streak || 0;
  document.getElementById('statGrowth').textContent = (data.deedsDone||[]).filter(Boolean).length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GROWTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDeedsState() {
  for (let i=0; i<3; i++) { const el=document.getElementById('deed-'+i); if(el) el.textContent=(data.deedsDone||[])[i]?'âœ…':'â¬œ'; }
}
function toggleGoodDeed(i) {
  if (!data.deedsDone) data.deedsDone=[];
  data.deedsDone[i]=!data.deedsDone[i]; save(); renderDeedsState(); renderTodayStats();
  if (data.deedsDone[i]) notify('ğŸŒŸ ××¢×©×” ×˜×•×‘ × ×¨×©×!');
}
function addCustomDeed() {
  const val=document.getElementById('customDeed').value.trim(); if(!val) return;
  const div=document.createElement('div'); div.className='growth-item';
  div.innerHTML=`<span class="growth-icon">âœ¨</span><div class="growth-text"><div class="growth-title">${val}</div></div><span>âœ…</span>`;
  document.getElementById('dailyGoodDeeds').appendChild(div);
  document.getElementById('customDeed').value='';
  if(!data.deedsDone) data.deedsDone=[];
  data.deedsDone.push(true); save(); renderTodayStats();
  notify('âœ¨ ××¢×©×” ×˜×•×‘ × ×¨×©×!');
}

function renderContribState() {
  for (let i=0; i<3; i++) { const el=document.getElementById('contrib-'+i); if(el) el.textContent=(data.contribsDone||[])[i]?'âœ…':'â¬œ'; }
  document.getElementById('contribStreak').textContent = data.contribStreak||0;
}
function toggleContrib(i) {
  if(!data.contribsDone) data.contribsDone=[];
  data.contribsDone[i]=!data.contribsDone[i]; save(); renderContribState();
  if(data.contribsDone[i]) notify('ğŸŒ ×ª×¨×•××” × ×¨×©××”!');
}
function addCustomContrib() {
  const val=document.getElementById('customContrib').value.trim(); if(!val) return;
  const div=document.createElement('div'); div.className='growth-item';
  div.innerHTML=`<span class="growth-icon">ğŸŒŸ</span><div class="growth-text"><div class="growth-title">${val}</div></div><span>âœ…</span>`;
  document.getElementById('weeklyContributions').appendChild(div);
  document.getElementById('customContrib').value='';
  notify('ğŸŒ ×ª×¨×•××” × ×¨×©××”!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEDITATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let medSec=300, medTotal=300, medInt=null, medOn=false;
function setMedTime(m) { if(medOn) return; medSec=medTotal=m*60; updateMedDisplay(); }
function toggleMeditation() {
  if (medOn) {
    clearInterval(medInt); medOn=false;
    document.getElementById('medBtn').textContent='â–¶ ×”××©×š';
    document.getElementById('medText').textContent='××•×©×”×”';
  } else {
    medOn=true;
    document.getElementById('medBtn').textContent='â¸ ×”×©×”×”';
    document.getElementById('medText').textContent='× ×©×•×... ×”×¨×’×¢...';
    medInt=setInterval(()=>{ medSec--; updateMedDisplay(); if(medSec<=0){ clearInterval(medInt); medOn=false; document.getElementById('medBtn').textContent='â–¶ ××“×™×˜×¦×™×” ×—×“×©×”'; document.getElementById('medText').textContent='ğŸ™ ×¡×™×™××ª! ×›×œ ×”×›×‘×•×“'; notify('ğŸ§˜ ××“×™×˜×¦×™×” ×”×•×©×œ××”!'); } },1000);
  }
}
function updateMedDisplay() {
  const m=Math.floor(medSec/60), s=medSec%60;
  document.getElementById('medTimer').textContent=`${m}:${s.toString().padStart(2,'0')}`;
  document.getElementById('medCircle').style.strokeDashoffset = 346*(1-(medTotal-medSec)/medTotal);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReport() {
  const done=data.tasks.filter(t=>t.done).length, total=data.tasks.length;
  const eff=total>0?Math.round(done/total*100):0;
  const deeds=(data.deedsDone||[]).filter(Boolean).length;
  const contribs=(data.contribsDone||[]).filter(Boolean).length;
  document.getElementById('reportCompleted').textContent=done;
  document.getElementById('reportEfficiency').textContent=eff+'%';
  document.getElementById('reportDeeds').textContent=deeds;
  document.getElementById('reportContribs').textContent=contribs;
  const goods=[], imps=[];
  if(eff>=80) goods.push('×™×¢×™×œ×•×ª ×’×‘×•×”×” ×-80% ×‘××©×™××•×ª! ğŸ¯'); else imps.push('×©××¤×• ×œ×¡×™×™× ×œ×¤×—×•×ª 80% ××”××©×™××•×ª');
  if(deeds>=3) goods.push('×‘×™×¦×¢×ª ××¢×©×™× ×˜×•×‘×™×! ğŸŒŸ'); else imps.push('× ×¡×” ×œ×”×’×™×¢ ×œ-3+ ××¢×©×™× ×˜×•×‘×™× ×‘×™×•×');
  if(contribs>=1) goods.push('×ª×¨××ª ×œ×¡×‘×™×‘×”/×—×‘×¨×” ×”×©×‘×•×¢! ğŸŒ'); else imps.push('×”×©×‘×•×¢ ×¢×“×™×™×Ÿ ×œ× ×¨×©××ª ×ª×¨×•××” ×œ×¡×‘×™×‘×”');
  if(data.schedule.length>0) goods.push('×™×© ×œ×š ×œ×•×— ×–×× ×™× ××¡×•×“×¨ âœ…'); else imps.push('×”×•×¡×£ ×œ×•×— ×–×× ×™× ×™×•××™');
  if(data.reminders.length>0) goods.push('×™×© ×œ×š ×ª×–×›×•×¨×•×ª ×—×©×•×‘×•×ª ğŸ””'); else imps.push('×”×•×¡×£ ×ª×–×›×•×¨×•×ª ×œ××™×¨×•×¢×™× ×—×©×•×‘×™×');
  document.getElementById('reportGood').innerHTML=goods.map(g=>`<li>âœ… ${g}</li>`).join('');
  document.getElementById('reportImprove').innerHTML=imps.map(i=>`<li>ğŸ’¡ ${i}</li>`).join('');
}
function saveNotes() { data.weeklyNotes=document.getElementById('weeklyNotes').value; save(); notify('ğŸ“ × ×©××¨!'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function saveGratitude() {
  const text = document.getElementById('gratitudeText').value;
  const intention = document.getElementById('intentionText').value;
  data.gratitude = { text, intention, date: new Date().toDateString() };
  save();
  notify('ğŸ™ ×”×›×¨×ª ×ª×•×“×” × ×©××¨×”!');
  closeModal('gratitudeModal');
  // ×©××™×¨×” ×’× ×‘-Google Sheets
  if (text) saveGratitudeToServer(text);
}
function saveEveningReview() {
  data.eveningReview={ best:document.getElementById('eveningBest').value, improve:document.getElementById('eveningImprove').value, tomorrow:document.getElementById('eveningTomorrow').value, date:new Date().toDateString() };
  save(); notify('ğŸŒ™ ×¡×™×›×•× ×™×•× × ×©××¨!'); closeModal('eveningModal');
}
function saveWeeklyReview() {
  data.weeklyReview={ achieve:document.getElementById('weeklyAchieve').value, learn:document.getElementById('weeklyLearn').value, goals:document.getElementById('weeklyGoals').value, date:new Date().toDateString() };
  save(); notify('ğŸ“… ×¡×™×›×•× ×©×‘×•×¢×™ × ×©××¨!'); closeModal('weeklyModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ××¢×¨×›×ª ×©×™×—×” ×§×•×œ×™×ª ××•×˜×•××˜×™×ª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let recognition = null;
let voiceFlow = null;
let voiceData = {};
let isListening = false;

function showVoiceCard(text) {
  document.getElementById('voiceConvCard').classList.add('active');
  document.getElementById('voiceConvText').textContent = text;
}

function hideVoiceCard() {
  document.getElementById('voiceConvCard').classList.remove('active');
}

function listenForAnswer(onResult) {
  if (isListening) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return;

  recognition = new SR();
  recognition.lang = 'he-IL';
  recognition.continuous = false;
  recognition.interimResults = false; // ×¨×§ ×ª×•×¦××” ×¡×•×¤×™×ª â€” ×œ×œ× ×”×©×”×™×” ××™×•×ª×¨×ª

  isListening = true;
  document.getElementById('voiceBtn').classList.add('listening');
  document.getElementById('voiceBtn').textContent = 'ğŸ”´';

  recognition.onresult = e => {
    const text = e.results[0][0].transcript.trim();
    document.getElementById('transcriptBar').textContent = text;
    document.getElementById('transcriptBar').classList.add('active');
    isListening = false;
    recognition.stop();
    if (onResult) onResult(text);
  };

  recognition.onend = () => {
    isListening = false;
    document.getElementById('voiceBtn').classList.remove('listening');
    document.getElementById('voiceBtn').textContent = 'ğŸ¤';
  };

  recognition.onerror = () => {
    isListening = false;
    document.getElementById('voiceBtn').classList.remove('listening');
    document.getElementById('voiceBtn').textContent = 'ğŸ¤';
    showVoiceCard('×œ× ×©××¢×ª×™, × ×¡×” ×©×•×‘');
  };

  recognition.start();
}

function speak(text, onDone) {
  if (!('speechSynthesis' in window)) {
    if (onDone) setTimeout(onDone, 100);
    return;
  }
  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'he-IL';
  u.rate = 1.05;
  u.pitch = 1;

  let done = false;
  function finish() {
    if (!done) { done = true; if (onDone) onDone(); }
  }

  // fallback â€” ×× ×”×§×•×œ ×œ× ×”×ª×—×™×œ ×ª×•×š 3 ×©× ×™×•×ª ×××©×™×š ×‘×œ×™ ×§×•×œ
  const fallback = setTimeout(finish, 3000);
  u.onend = () => { clearTimeout(fallback); finish(); };
  u.onerror = () => { clearTimeout(fallback); finish(); };

  window.speechSynthesis.speak(u);
}

function askThenListen(question, onAnswer) {
  showVoiceCard(question);
  speak(question, () => {
    setTimeout(() => listenForAnswer(onAnswer), 300);
  });
}

// â”€â”€ ×¤×§×•×“×” ×¨××©×™×ª â”€â”€
function toggleVoice() {
  const hasSR = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
  if (!hasSR) { notify('×–×™×”×•×™ ×§×•×œ ×–××™×Ÿ ×¨×§ ×‘×“×¤×“×¤×Ÿ ×›×¨×•×'); return; }

  if (voiceFlow) {
    window.speechSynthesis.cancel();
    if (recognition) recognition.stop();
    voiceFlow = null;
    voiceData = {};
    isListening = false;
    hideVoiceCard();
    document.getElementById('voiceBtn').textContent = 'ğŸ¤';
    document.getElementById('voiceLabel').textContent = '×œ×—×¥ ×œ×“×™×‘×•×¨';
    document.getElementById('transcriptBar').classList.remove('active');
    return;
  }

  voiceFlow = 'active';
  voiceData = {};
  document.getElementById('voiceLabel').textContent = '××“×‘×¨...';
  document.getElementById('transcriptBar').classList.add('active');

  // ×¤×ª×™×—×ª ×× ×•×¢ ×”×§×•×œ ×©×œ ×× ×“×¨×•××™×“ â€” ×—×™×™×‘ ×œ×§×¨×•×ª ×™×©×™×¨×•×ª ×‘×ª×’×•×‘×” ×œ×œ×—×™×¦×”
  if ('speechSynthesis' in window) {
    const unlock = new SpeechSynthesisUtterance(' ');
    unlock.volume = 0;
    window.speechSynthesis.speak(unlock);
    setTimeout(() => {
      window.speechSynthesis.cancel();
      askThenListen('×©×œ×•×! ××” ×ª×¨×¦×” ×œ×¢×©×•×ª?', handleMainCommand);
    }, 100);
  } else {
    askThenListen('×©×œ×•×! ××” ×ª×¨×¦×” ×œ×¢×©×•×ª?', handleMainCommand);
  }
}

function handleMainCommand(text) {
  // ×•×•×“× ×©×× ×—× ×• ×¢×“×™×™×Ÿ ×‘×ª×•×š ×–×¨×™××” ×¤×¢×™×œ×”
  if (!voiceFlow) return;

  const t = text;

  if (t.includes('××©×™××”') || t.includes('××˜×œ×”') || t.includes('×¦×¨×™×š') || t.includes('×œ×”×•×¡×™×£') || t.includes('×”×•×¡×£')) {
    // × ×¡×” ×œ×—×œ×¥ ×©× ××©×™××” ××”××©×¤×˜ ×¢×¦××•
    let name = t
      .replace('×”×•×¡×£ ××©×™××”','').replace('××©×™××” ×—×“×©×”','')
      .replace('×¦×¨×™×š ×œ','').replace('×ª×–×›×™×¨ ×œ×™ ×œ','')
      .replace('××©×™××”','').replace('×”×•×¡×£','')
      .trim();

    if (name && name.length > 1) {
      voiceData.name = name;
      askAboutDate();
    } else {
      askThenListen('××” ×©× ×”××©×™××”?', ans => {
        voiceData.name = ans;
        askAboutDate();
      });
    }

  } else if (t.includes('×ª×–×›×•×¨×ª')) {
    document.querySelectorAll('.tab')[3].click();
    endVoiceFlow('×¢×•×‘×¨ ×œ×ª×–×›×•×¨×•×ª');

  } else if (t.includes('×“×•×—')) {
    document.querySelectorAll('.tab')[5].click();
    endVoiceFlow('××¦×™×’ ×“×•×— ×©×‘×•×¢×™');

  } else if (t.includes('××“×™×˜×¦×™×”') || t.includes('×“××™×•×Ÿ')) {
    document.querySelectorAll('.tab')[4].click();
    endVoiceFlow('× ×¤×ª×— ××¡×š ×”××“×™×˜×¦×™×”');

  } else if (t.includes('×ª×•×“×”') || t.includes('×”×›×¨×ª ×ª×•×“×”')) {
    openModal('gratitudeModal');
    endVoiceFlow('×¤×•×ª×— ×”×›×¨×ª ×ª×•×“×”');

  } else {
    askThenListen('×œ× ×”×‘× ×ª×™. ×××•×¨ ××©×™××”, ×ª×–×›×•×¨×ª, ×“×•×— ××• ××“×™×˜×¦×™×”', handleMainCommand);
  }
}

function askAboutDate() {
  if (!voiceFlow) return;
  askThenListen('×œ××ª×™? ×”×™×•×, ××—×¨, ××• ×™×•× ×‘×©×‘×•×¢?', ans => {
    if (!voiceFlow) return;
    const d = new Date();
    const a = ans;
    if (a.includes('××—×¨')) {
      d.setDate(d.getDate() + 1);
    } else if (!a.includes('×”×™×•×')) {
      const days = { '×¨××©×•×Ÿ':0,'×©× ×™':1,'×©×œ×™×©×™':2,'×¨×‘×™×¢×™':3,'×—××™×©×™':4,'×©×™×©×™':5,'×©×‘×ª':6 };
      const foundDay = Object.keys(days).find(day => a.includes(day));
      if (foundDay) {
        const diff = (days[foundDay] - d.getDay() + 7) % 7 || 7;
        d.setDate(d.getDate() + diff);
      }
    }
    voiceData.date = d.toISOString().split('T')[0];
    askAboutPeople();
  });
}

function askAboutPeople() {
  if (!voiceFlow) return;
  askThenListen('××™ ×§×©×•×¨? ×××•×¨ ×©× ××• â€” ××£ ××—×“', ans => {
    if (!voiceFlow) return;
    const a = ans;
    voiceData.people = (a.includes('××£ ××—×“') || a.includes('×œ×') || a.includes('×“×œ×’') || a.includes('×œ×œ×')) ? '' : a;
    askAboutReminder();
  });
}

function askAboutReminder() {
  if (!voiceFlow) return;
  askThenListen('××ª×™ ×œ×”×ª×¨×™×¢? ××•×ª×• ×™×•×, ×™×•× ×œ×¤× ×™, ×©×‘×•×¢ ×œ×¤× ×™, ××• ×œ×œ×', ans => {
    if (!voiceFlow) return;
    const a = ans;
    if (a.includes('×™×•× ×œ×¤× ×™') || a.includes('×™×•× ×§×•×“×')) voiceData.reminder = 'day_before';
    else if (a.includes('×©×‘×•×¢')) voiceData.reminder = 'week_before';
    else if (a.includes('××•×ª×•') || a.includes('×‘×™×•×') || a.includes('××•×ª×”')) voiceData.reminder = 'same';
    else voiceData.reminder = '';
    confirmTask();
  });
}

function confirmTask() {
  if (!voiceFlow) return;
  const peopleStr = voiceData.people ? `, ×¢× ${voiceData.people}` : '';
  const msg = `×©×•××¨ â€” ${voiceData.name}${peopleStr}. × ×›×•×Ÿ?`;
  askThenListen(msg, ans => {
    if (!voiceFlow) return;
    if (ans.includes('×›×Ÿ') || ans.includes('× ×›×•×Ÿ') || ans.includes('×‘×¡×“×¨') || ans.includes('×™××œ×œ×”') || ans.includes('××™×©×•×¨')) {
      saveVoiceTask();
    } else {
      askThenListen('××” ×”×©× ×”× ×›×•×Ÿ?', newName => {
        if (!voiceFlow) return;
        voiceData.name = newName;
        saveVoiceTask();
      });
    }
  });
}

function saveVoiceTask() {
  if (!voiceFlow) return;
  let alertDate = '';
  if (voiceData.reminder === 'same') alertDate = voiceData.date;
  else if (voiceData.reminder === 'day_before') {
    const d = new Date(voiceData.date); d.setDate(d.getDate() - 1);
    alertDate = d.toISOString().split('T')[0];
  } else if (voiceData.reminder === 'week_before') {
    const d = new Date(voiceData.date); d.setDate(d.getDate() - 7);
    alertDate = d.toISOString().split('T')[0];
  }

  data.tasks.unshift({
    id: Date.now(), name: voiceData.name,
    duration: '30', category: '××—×¨', priority: 'medium',
    date: voiceData.date, people: voiceData.people || '',
    reminder: voiceData.reminder || '', alertDate, done: false
  });

  save();
  document.querySelectorAll('.tab')[1].click();
  renderTasks(); renderTodayStats();
  endVoiceFlow(`××¢×•×œ×”! "${voiceData.name}" × ×©××¨×”`);
}

function endVoiceFlow(msg) {
  showVoiceCard(msg);
  speak(msg, () => {
    setTimeout(() => {
      hideVoiceCard();
      document.getElementById('transcriptBar').classList.remove('active');
      document.getElementById('voiceLabel').textContent = '×œ×—×¥ ×œ×“×™×‘×•×¨';
      document.getElementById('voiceBtn').textContent = 'ğŸ¤';
      voiceFlow = null;
      voiceData = {};
      isListening = false;
    }, 500);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTIFICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function notify(msg) {
  const el=document.getElementById('notification');
  el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFAULT REMINDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (!data.reminders.length) {
  [{ title:'×©×™×—×” ×¢× ×”×”×•×¨×™×', type:'family', recurrence:'weekly' },
   { title:'×¢×¨×‘ ×–×•×’×™', type:'couple', recurrence:'weekly' },
   { title:'×©××™×¨×ª ×§×©×¨ ×¢× ×—×‘×¨×™×', type:'friends', recurrence:'monthly' }]
  .forEach((r,i) => data.reminders.push({ id:Date.now()+i, ...r, date:'' }));
  save();
}

// â”€â”€ CLOSE MODAL ON OVERLAY CLICK â”€â”€
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
});

init();
</script>
</body>
</html>
